<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test Harness - Hello World</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }

        #controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            opacity: 0.9;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .status strong {
            font-weight: 600;
        }

        #widget-container {
            background: white;
            margin: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }

        .instructions {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .instructions h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            color: #4a5568;
        }

        .instructions code {
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h1>üß™ Widget Test Harness</h1>
        <p class="subtitle">Test your Hello World widget with different data scenarios</p>

        <div class="button-group">
            <button onclick="loadWithGreeting()">‚úÖ Casual Greeting</button>
            <button onclick="loadFormal()">üé© Formal Greeting</button>
            <button onclick="loadWithError()">‚ùå Error State</button>
            <button onclick="loadEmpty()">üì≠ Dev Mode</button>
            <button onclick="toggleDark()">üåì Theme: <span id="themeLabel">Light</span></button>
        </div>

        <div class="status" id="status">
            <strong>Status:</strong> Ready to test. Click a button above to load the widget.
        </div>
    </div>

    <div id="widget-container">
        <iframe id="widget"></iframe>
    </div>

    <div class="instructions">
        <h2>üìã Instructions</h2>
        <ol>
            <li>Make sure the dev server is running: <code>npm run dev</code></li>
            <li>Click any button above to inject test data</li>
            <li>The widget will load with that data (simulating ChatGPT)</li>
            <li>Try different scenarios to test all widget states</li>
        </ol>
    </div>

    <script>
        let theme = 'light';

        function updateStatus(msg) {
            document.getElementById('status').innerHTML = '<strong>Status:</strong> ' + msg;
        }

        function injectData(iframe, data, description) {
            try {
                const win = iframe.contentWindow;

                // Inject window.openai API
                win.openai = {
                    theme: theme,
                    displayMode: 'inline',
                    maxHeight: 600,
                    locale: 'en-US',
                    userAgent: {
                        device: { type: 'desktop' },
                        capabilities: { hover: true, touch: false }
                    },
                    safeArea: {
                        insets: { top: 0, bottom: 0, left: 0, right: 0 }
                    },
                    toolInvocation: {
                        output: data
                    },
                    toolInput: null,
                    toolOutput: data,
                    toolResponseMetadata: null,
                    widgetState: null,
                    setWidgetState: async function(state) {
                        console.log('setWidgetState called:', state);
                        return Promise.resolve();
                    },
                    callTool: async function(name, args) {
                        console.log('callTool called:', name, args);
                        alert('Tool called: ' + name + '\nArgs: ' + JSON.stringify(args, null, 2));
                        return Promise.resolve();
                    }
                };

                // Dispatch the custom event that the widget listens for
                win.dispatchEvent(new Event('openai:set_globals'));

                updateStatus('‚úÖ Loaded with ' + description + '! Theme: ' + theme);
            } catch (e) {
                updateStatus('‚ùå Error: ' + e.message + '. Make sure server is running at http://localhost:4444');
                console.error('Failed to inject data:', e);
            }
        }

        function loadWidget(data, description) {
            updateStatus('Loading widget with ' + description + '...');
            const iframe = document.getElementById('widget');

            // Check if iframe is already loaded
            if (iframe.src === 'http://localhost:4444/' || iframe.src === 'http://localhost:4444') {
                // Already loaded, just inject data directly
                injectData(iframe, data, description);
            } else {
                // Not loaded yet, set up onload handler
                iframe.onload = function() {
                    injectData(iframe, data, description);
                    iframe.onload = null; // Remove handler
                };
                // Load the widget
                iframe.src = 'http://localhost:4444';
            }
        }

        function loadWithGreeting() {
            loadWidget({
                greeting: 'Hello, John!',
                formal: false,
                timestamp: new Date().toISOString(),
            }, 'casual greeting');
        }

        function loadFormal() {
            loadWidget({
                greeting: 'Good day, Sarah.',
                formal: true,
                timestamp: new Date().toISOString(),
            }, 'formal greeting');
        }

        function loadWithError() {
            loadWidget({
                error: true,
                message: 'This is a test error message! The widget should display this in a red error box.',
                timestamp: new Date().toISOString(),
            }, 'error state');
        }

        function loadEmpty() {
            updateStatus('Loading widget in dev mode (no data)...');
            const iframe = document.getElementById('widget');
            iframe.onload = function() {
                updateStatus('‚úÖ Loaded in dev mode! Should show warning screen.');
            };
            iframe.src = 'http://localhost:4444';
        }

        function toggleDark() {
            theme = theme === 'light' ? 'dark' : 'light';
            document.getElementById('themeLabel').textContent =
                theme.charAt(0).toUpperCase() + theme.slice(1);
            updateStatus('üåì Theme changed to <strong>' + theme + '</strong>. Click a load button to apply.');
        }

        // Auto-load with greeting on page load
        window.onload = function() {
            setTimeout(function() {
                loadWithGreeting();
            }, 500);
        };
    </script>
</body>
</html>
