<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test Harness</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .controls {
            max-width: 800px;
            margin: 0 auto 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls h2 {
            margin-top: 0;
        }
        .controls button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #5568d3;
        }
        .controls input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .widget-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #e3f2fd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h2>üß™ Widget Test Harness</h2>

        <div class="status" id="status">
            Widget URL: <strong>http://localhost:4444</strong>
        </div>

        <div style="margin: 15px 0;">
            <strong>Test Data:</strong><br>
            <input type="text" id="nameInput" placeholder="Name" value="John Doe">
            <label>
                <input type="checkbox" id="formalCheck"> Formal greeting
            </label>
        </div>

        <div>
            <button onclick="loadWidget()">üöÄ Load Widget with Data</button>
            <button onclick="loadWidgetEmpty()">üì≠ Load Empty State</button>
            <button onclick="loadWidgetError()">‚ùå Load Error State</button>
            <button onclick="toggleTheme()">üåì Toggle Theme</button>
        </div>

        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            <strong>Tips:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Make sure <code>npm run dev</code> is running in widget-react folder</li>
                <li>The iframe below loads the widget and injects test data</li>
                <li>Change the name/formal checkbox and click "Load Widget" again</li>
            </ul>
        </div>
    </div>

    <div class="widget-container">
        <iframe id="widgetFrame" src="about:blank"></iframe>
    </div>

    <script>
        let currentTheme = 'light';

        function loadWidget() {
            const name = document.getElementById('nameInput').value || 'John Doe';
            const formal = document.getElementById('formalCheck').checked;

            const greeting = formal
                ? `Good day, ${name}.`
                : `Hello, ${name}!`;

            const data = {
                greeting: greeting,
                formal: formal,
                timestamp: new Date().toISOString(),
            };

            injectWidget(data);
            document.getElementById('status').innerHTML =
                `‚úÖ Widget loaded with data: <code>${JSON.stringify(data)}</code>`;
        }

        function loadWidgetEmpty() {
            injectWidget(null);
            document.getElementById('status').innerHTML =
                `üì≠ Widget loaded with no data (should show dev mode)`;
        }

        function loadWidgetError() {
            const errorData = {
                error: true,
                message: 'This is a test error message',
                timestamp: new Date().toISOString(),
            };
            injectWidget(errorData);
            document.getElementById('status').innerHTML =
                `‚ùå Widget loaded with error: <code>${errorData.message}</code>`;
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.getElementById('status').innerHTML =
                `üåì Theme changed to: <strong>${currentTheme}</strong>`;
            // Reload to apply new theme
            if (document.getElementById('widgetFrame').src !== 'about:blank') {
                loadWidget();
            }
        }

        function injectWidget(toolData) {
            const iframe = document.getElementById('widgetFrame');

            // Load the widget
            iframe.src = 'http://localhost:4444';

            // Wait for it to load, then inject window.openai
            iframe.onload = function() {
                try {
                    const iframeWindow = iframe.contentWindow;

                    // Inject window.openai API
                    iframeWindow.openai = {
                        theme: currentTheme,
                        displayMode: 'inline',
                        maxHeight: 600,
                        locale: 'en-US',
                        userAgent: {
                            device: { type: 'desktop' },
                            capabilities: { hover: true, touch: false }
                        },
                        safeArea: {
                            insets: { top: 0, bottom: 0, left: 0, right: 0 }
                        },
                        toolInput: null,
                        toolOutput: toolData,
                        toolInvocation: {
                            output: toolData
                        },
                        toolResponseMetadata: null,
                        widgetState: null,
                        setWidgetState: async (state) => {
                            console.log('setWidgetState called:', state);
                        },
                        callTool: async (name, args) => {
                            console.log('callTool called:', name, args);
                            alert(`Tool called: ${name}\nArgs: ${JSON.stringify(args, null, 2)}`);
                        },
                        sendFollowUpMessage: async (args) => {
                            console.log('sendFollowUpMessage called:', args);
                        },
                        openExternal: (payload) => {
                            console.log('openExternal called:', payload);
                            window.open(payload.href, '_blank');
                        },
                        requestDisplayMode: async (args) => {
                            console.log('requestDisplayMode called:', args);
                        }
                    };

                    // Trigger a reload in the iframe to apply the data
                    iframeWindow.location.reload();
                } catch (e) {
                    console.error('Could not inject window.openai:', e);
                    document.getElementById('status').innerHTML =
                        `‚ùå Error: Could not inject data. Make sure widget is from localhost:4444`;
                }
            };
        }

        // Load widget with default data on page load
        setTimeout(() => {
            loadWidget();
        }, 500);
    </script>
</body>
</html>
